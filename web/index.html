<!--
# Copyright (C) 2012 Intel Corporation
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Authors:
#              Zhang, Huihui <huihuix.zhang@intel.com>
#              Wendong,Sui  <weidongx.sun@intel.com>
-->
<html>
<head>
<style type="text/css">
*{text-decoration: none;font: normal sans-serif, arial, helvetica;color: black;}
body {margin: 2px;}
iframe{border: 1px solid gray;width: 100%;}
div{width: 100%;}
.listtable tr:hover td, .listtable th{background: #f0f0f0;cursor:pointer;}
.listtable td {border-bottom: 1px dotted #f0f0f0;}
.listtable {width: 100%;}
.listtable th{width: 50px; background: #f0f0f0;}
.layouttable {width: auto;}
.button{border-radius:2px;border: 0px;background: gray;color: white;}
.button:hover{box-shadow:1px 1px 2px gray;}
.button:active{box-shadow:1px 1px 2px gray;background: transparent;color: black;}
.selectbox {border-radius: 2px;border: 1px solid gray;}
.label, .button {font-weight: bold;}
.checkbox{vertical-align:bottom;border: 1px solid gray;}
#pageswitch01, #pageswitch02{overflow: auto;}
#caselists{height: auto;border:1pt solid gray;overflow:auto;}
#casedesctext {color: #b0b0b0;}
#closewindowbutton {background: red;}
#closewindowbutton:hover {box-shadow:1px 1px 2px red;}
#closewindowbutton:active {box-shadow:1px 1px 2px gray;background: transparent;color: black;}
</style>
<script src="jquery.js"></script>
<script>
	var defTime = 2000;
	var winCloseTimeout = 5000;
	var server = "http://127.0.0.1:8000";
	var need_ajax = true;

	var Tests;
	var xmldoc;
	var startTime;
	var timeout;
	var cursuite;
	var curset;
	var last_test_page = "";
	var current_page_uri = "";
	var activetest = true;
	var iTest = 0;

	var ttestsuite;
	var tpriority;
	var tstatus;
	var ttype;
	var tcategory;
	var texecutiontype;
	var tset;
	var manualcaseslist;
	var cursuite;
	var curset;
	var last_test_page = "";
	var current_page_uri = "";
	var activetest = true;

	var statusNode;
        var testFrame;
        var statusFrame;
        var messageFrame;
	var caseListArea;
	var controlArea;
	var testArea;
	var caseListArea;
	var manageArea;
	var loadingArea;
	var iSuite;
	var iSet;
	var iEXEType;
	var pageIndex = 1;
	var caseListNum = 20;
	var casePageNum;
	var runInSer = false;

	var manualcases = function() {
		this.casesid = "";
		this.index = 0;
		this.result = "";
	};

	function getTestPageParam(uri, param) {
		var uri_local = uri;
		var iLen = param.length;
		var iStart = uri_local.indexOf(param);
		if (iStart == -1)
			return "";
		iStart += iLen + 1;
		var iEnd = uri_local.indexOf("&", iStart);
		if (iEnd == -1)
			return uri_local.substring(iStart);
			return uri_local.substring(iStart, iEnd);
	}

	function Parm(data, name) {
		var p;
		ts = $(data).find(name);
		if (ts) {
			t = $(ts).get(0);
			if (t)
				p = $(t).text().trim();
		}
		if (p) {
			var rawVal = decodeURI(p);
			if (rawVal.indexOf(',') < 0)
				p = rawVal;
			else
				p = rawVal.split(',');
		}
		return p;
	}

	function getParms() {
		var parms = new Array();
		var str = location.search.substring(1);
		var items = str.split('&');
		for ( var i = 0; i < items.length; i++) {
			var pos = items[i].indexOf('=');
			if (pos > 0) {
				var key = items[i].substring(0, pos);
				var val = items[i].substring(pos + 1);
				if (!parms[key]) {
					var rawVal = decodeURI(val);
					if (rawVal.indexOf(',') < 0)
						parms[key] = rawVal;
					else
						parms[key] = rawVal.split(',');
				}
			}
		}

		ttestsuite = parms["testsuite"];
		tpriority = parms["priority"];
		tstatus = parms["status"];
		ttype = parms["type"];
		tcategory = parms["category"];
		texecutiontype = parms["execution_type"];
		tset = parms["set"];
	}

	function updateXMLByParms(xml){
		$(xml).find("set").each(
		function(){
			var v = $(this).attr('name');
			if(tset && v != tset){
				$(this).remove();
			}
		});
		$(xml).find("testcase").each(
		function() {
			var v, vType;
			v = $(this).attr('execution_type');
			if (texecutiontype && texecutiontype == "manual")
				vType = "manual";
			else if (texecutiontype && texecutiontype == "auto")
				vType = "auto";
			else if (!texecutiontype)
				vType = [ "auto", "manual" ];
			else
				vType = "auto";
			if (v != vType && $.inArray(v, vType) < 0)
				$(this).remove();
			v = $(this).attr('priority');
			if (tpriority && v != tpriority
				&& $.inArray(v, tpriority) < 0)
				$(this).remove();
			v = $(this).attr('status');
			if (tstatus && v != tstatus && $.inArray(v, tstatus) < 0)
				$(this).remove();
			v = $(this).attr('type');
			if (ttype && v != ttype && $.inArray(v, ttype) < 0)
				$(this).remove();
			var categories = $(this).find("categories > category");
				if (categories.length > 0 && tcategory) {
					var i;
					var found = false;
					for (i = 0; i < categories.length; i++) {
						var category = $(categories).get(i);
						if ($(category).text().trim() != tcategory
								&& $.inArray($(category).text().trim(),
										tcategory) < 0) {
							found = true;
							break;
						}
					}
					if (!found)
						$(this).remove();
				}

				$(this).attr('result', "N/A");
		});
		return xml;
	}

	function runTestSuite(xml) {
		$("#versionrow").hide();
		document.getElementById("suitelist").options.length=0;
		var i=0;
		$(xml).find("suite").each(
			function(){
				var suitename = $(this).attr('name');
				document.getElementById("suitelist").options.add(new Option(suitename, i));
				i++;
		});
		xml = updateXMLByParms(xml);
		initSets(xml);
		loadingArea.hide();
		controlArea.show();
	}

	function resizeFontSize(){
		var fontSize;
		if (screen.width <= 600)
			fontSize="40px";
		else if (screen.width <= 800 )
			fontSize="40px";
		else if (screen.width <= 1000 )
			fontSize="25px";

		$('*').css("font-size", fontSize);
	}

	//Selection page start
	function initCases(xml){
		iSuiteIndex = document.getElementById("suitelist").selectedIndex;
		iSuite = document.getElementById("suitelist").options[iSuiteIndex].text;
		iSetIndex = document.getElementById("setlist").selectedIndex;
		iSet = document.getElementById("setlist").options[iSetIndex].text;
		iEXETypeIndex = document.getElementById("exetypelist").selectedIndex;
		iEXEType = document.getElementById("exetypelist").options[iEXETypeIndex].text;
		if(iSet != "All"){
			$(xml).find("set").each(
				function(){
					if ($(this).attr('name') != document.getElementById("setlist").options[iSetIndex].text){
						$(this).remove();
					}
			});
		}

		if(iEXEType != "All"){
			var iiEXEType='';
			if (iEXEType == "Manual"){
				iiEXEType="manual";
			}else if (iEXEType == "Auto"){
				iiEXEType="auto";
			}

			$(xml).find("testcase").each(
				function(){
					if ($(this).attr('execution_type') != iiEXEType){
						$(this).remove();
					}
			});
		}
		Tests = $(xml).find("testcase");
		xmldoc = xml;
		casePageNum=Math.ceil(Tests.length/caseListNum);
	}

	function showCase(iTest){
		var ts = $(Tests[iTest]).find('test_script_entry');
		var it = $(ts).get(0);
		if(document.getElementById('iframebox').checked){
			testArea.show();
			if ($(Tests[iTest]).attr('execution_type') == "manual"){
				$("#statusframe").show();
				statusFrameContent = document.getElementById('statusframe').contentWindow;
				statusFrameContent.document.body.innerHTML = "";
				//caseslistinfo = "Case ID: "+$(Tests[iTest]).attr('id')+"<br>";
				caseslistinfo = "Descriptions: "+$(Tests[iTest]).attr('purpose')+"<br>";
	
				var preC = $(Tests[iTest]).find('pre_condition');
				if (preC && preC.length > 0){
					var preCText = $(preC).get(0);
					caseslistinfo += "PreCondition: "+$(preCText).text().trim()+"<br>";
				}
	
				var posC = $(Tests[iTest]).find('post_condition');
				if (posC && posC.length > 0){
					var posCText = $(posC).get(0);
					caseslistinfo += "PostCondition: "+$(posCText).text().trim()+"<br>";
				}
				var stepInfo = $(Tests[iTest]).find('step_desc');
				var stepExp = $(Tests[iTest]).find('expected');
				for(var j=0;j<stepInfo.length;j++){
					var stepsnum = j + 1;
					if(stepInfo){
						var stepInfoText = $(stepInfo[j]).get(0);
						caseslistinfo += "Step-"+stepsnum+": "+$(stepInfoText).text().trim()+"<br>";
					}
					if(stepExp){
						var stepExpText = $(stepExp[j]).get(0);
						caseslistinfo += "Expected"+": "+$(stepExpText).text().trim()+"<br>";
					}
				}

				statusFrameContent.document.writeln(caseslistinfo);
			} else {
				$("#statusframe").hide();
			}

			if ($(it).text().length > 0){
				$("#testframe").show();
				testFrame.src=$(it).text();
				caseListArea.hide();
			} else {
				$("#testframe").hide();
			}
		}else{
			if ($(it).text().length > 0){
				window.open($(it).text());  		
				//window.location.href($(it).text());
                	} else {
                        	$("#testframe").hide();
                	}	
		}
	}

	function initParmsCases(xml){
		xml = updateXMLByParms(xml);
		initCases(xml);
	}

	function updateTestXML(){
		if (runInSer){
			iSuiteIndex = document.getElementById("suitelist").selectedIndex;
			$.ajax({
				async : false,
				type : "GET",
				url : "/usr/share/"+document.getElementById("suitelist").options[iSuiteIndex].text+"/tests.xml",
				dataType : "xml",
				success : initCases,
			});
		} else {
			$.ajax({
				async : false,
				type : "GET",
				url : ttestsuite,
				dataType : "xml",
				success : initParmsCases
			});
		}
	}

	function showCaseListIndex(){
		caseLists = document.getElementById("caselists");
		pageSwitch01 = document.getElementById("pageswitch01");
		pageSwitch02 = document.getElementById("pageswitch02");
		pageSwitch01.innerHTML='';
		pageSwitch02.innerHTML='';
		pageSwitch01.innerHTML+="<a href=\"javascript:gotoCaseListsPage('-1');\">Prev</a>&nbsp&nbsp;"
		pageSwitch02.innerHTML+="<a href=\"javascript:gotoCaseListsPage('-1');\">Prev</a>&nbsp&nbsp;"
		pageSwitch01.innerHTML+="<a href=\"javascript:showCaseListsPage('1');\">|\<\<</a>&nbsp&nbsp;";
		pageSwitch02.innerHTML+="<a href=\"javascript:showCaseListsPage('1');\">|\<\<</a>&nbsp&nbsp;";
		var startPage;
		if (pageIndex-4<1){
			startPage=1;
		}else if(pageIndex+4>casePageNum){
			startPage=casePageNum-8;
			if(startPage<1)
				startPage=1;
		}else{
			startPage=pageIndex-4;
		}
		for(var i=startPage; i<=casePageNum && i<=startPage+8; i++){
			if(i == pageIndex){
				pageSwitch01.innerHTML+="<a style=\"color:red\" href=\"javascript:showCaseListsPage('"+i+"');\"> "+i+" </a>&nbsp;";
				pageSwitch02.innerHTML+="<a style=\"color:red\" href=\"javascript:showCaseListsPage('"+i+"');\"> "+i+" </a>&nbsp;";
			}else {
				pageSwitch01.innerHTML+="<a href=\"javascript:showCaseListsPage('"+i+"');\"> "+i+" </a>&nbsp;";
				pageSwitch02.innerHTML+="<a href=\"javascript:showCaseListsPage('"+i+"');\"> "+i+" </a>&nbsp;";
			}
		}
		pageSwitch01.innerHTML+="<a href=\"javascript:showCaseListsPage('"+casePageNum+"');\">\>\>|</a>&nbsp&nbsp;";
		pageSwitch02.innerHTML+="<a href=\"javascript:showCaseListsPage('"+casePageNum+"');\">\>\>|</a>&nbsp&nbsp;";
		pageSwitch01.innerHTML+="<a href=\"javascript:gotoCaseListsPage('1');\">Next</a>&nbsp&nbsp;"
		pageSwitch02.innerHTML+="<a href=\"javascript:gotoCaseListsPage('1');\">Next</a>&nbsp&nbsp;"
	}

	function showCaseList(){
		caseLists = document.getElementById("caselists");
		caseLists.innerHTML='';
		if(casePageNum > 0){
			var caselistsinfo = "<table id=\"caselisttb\" class=\"listtable\">";
			var iTest = 0;
			while (iTest < caseListNum) {
				var iiTest = (pageIndex-1)*caseListNum+iTest;
				if(iiTest > Tests.length-1)
					break;
				caselistsinfo += "<tr id=\""+iiTest+"\"><th>"+[iiTest+1]+"</th><td>"+$(Tests[iiTest]).attr('id')+"<br><a id=\"casedesctext\">"+$(Tests[iiTest]).attr('purpose')+"</a></td></tr>";
				iTest++;
			}
			caselistsinfo += "</table>";
			caseLists.innerHTML=caselistsinfo;
			var lists = document.getElementById('caselisttb').getElementsByTagName('tr');
			for(var k=0;k<lists.length;k++){
				lists[k].onclick = function(){
					showCase(this.id);
				}
			}
		}
	}

	function showCaseListsPage(index){
		index=parseInt(index);

		if (index < 1){
			index = 1;
		}else if(index > casePageNum){
			index = casePageNum;
		}
		pageIndex = index;
		showCaseListIndex();
		showCaseList();
		resizeFontSize();
	}

	function gotoCaseListsPage(point){
		caseLists = document.getElementById("caselists");
		point=="-1"?showCaseListsPage(pageIndex-1):showCaseListsPage(pageIndex+1);
	 }

	function showCases(){
		testFrame.src='';
		testArea.hide();
		$("#testframe").hide();

		iSetIndex = document.getElementById("setlist").selectedIndex;
		iSuiteIndex = document.getElementById("suitelist").selectedIndex;
		iEXETypeIndex = document.getElementById("exetypelist").selectedIndex;
		if (iSuite != document.getElementById("suitelist").options[iSuiteIndex].text ||
		    iSet != document.getElementById("setlist").options[iSetIndex].text || 
			iEXEType != document.getElementById("exetypelist").options[iEXETypeIndex].text){
			updateTestXML();
			pageIndex=1;
			showCaseList();
		}
		showCaseListIndex();
		resizeFontSize();
		caseListArea.show();
	}

	function setUpdate(){

	}

        function setUpdateButtonDown(){
                var i = document.getElementById("setlist").selectedIndex;
                if (i+1 >= document.getElementById("setlist").options.length)
                        i=0;
                else
                        i++;
                document.getElementById("setlist").selectedIndex = i;
        }

	function setUpdateButtonUp(){
                var i = document.getElementById("setlist").selectedIndex;
		if(i <= 0)
			i = document.getElementById("setlist").options.length - 1;
                else
                        i--;
                document.getElementById("setlist").selectedIndex = i;
        }

	function exeTypeUpdate(){
		
	}

	function exeTypeUpdateButtonDown(){
                var i = document.getElementById("exetypelist").selectedIndex;
                if (i+1 >= document.getElementById("exetypelist").options.length)
                        i=0;
                else
                        i++;
                document.getElementById("exetypelist").selectedIndex = i;
        }

	function exeTypeUpdateButtonUp(){
                var i = document.getElementById("exetypelist").selectedIndex;
		if(i <= 0)
			i = document.getElementById("exetypelist").options.length - 1;
                else
                        i--;
                document.getElementById("exetypelist").selectedIndex = i;
        }

	function initExeType(){
		document.getElementById("exetypelist").options.length=0;
		document.getElementById("exetypelist").options.add(new Option("All", 0));
		document.getElementById("exetypelist").options.add(new Option("Manual", 0));
		document.getElementById("exetypelist").options.add(new Option("Auto", 0));
	}

	function initSets(xml){
		document.getElementById("setlist").options.length=0;
		var i = 0;
		$(xml).find("set").each(
			function(){
			document.getElementById("setlist").options.add(new Option($(this).attr('name'), i));
			i++;
		});
		document.getElementById("setlist").options.add(new Option("All", i));
		initExeType();
	}

	function suiteUpdate(){
		iSuiteIndex = document.getElementById("suitelist").selectedIndex;
		$.ajax({
			async : false,
			type : "GET",
			url : "/usr/share/"+document.getElementById("suitelist").options[iSuiteIndex].text+"/tests.xml",
			dataType : "xml",
			success : initSets,
		});
	}

	function suiteUpdateButtonDown(){
		var i = document.getElementById("suitelist").selectedIndex;
		if (i+1 >= document.getElementById("suitelist").options.length)
			i=0;
		else
			i++;
		document.getElementById("suitelist").selectedIndex = i;
		suiteUpdate();
        }
	
	function suiteUpdateButtonUp(){
                var i = document.getElementById("suitelist").selectedIndex;
		if (i <= 0)
			i = document.getElementById("suitelist").options.length - 1;
                else
                        i--;
                document.getElementById("suitelist").selectedIndex = i;
                suiteUpdate();
        }

	function runTestSuiteSer(){
		runInSer = true;
		$("#versionrow").hide();
		document.getElementById("suitelist").options.length=0;
		$(document).ready(function() {
		$.ajax({
			type:"GET",
			url:"config.json",
			dataType: "json",
			success: function(data){
				$.each(data,function(i,item){
				        if(item.suite){
                                                document.getElementById("suitelist").options.add(new Option(item.suite, i));
                                        } else if(item.version){
                                                $("#versiontext").text(item.version);
                                                $("#versionrow").show();
                                        }
				})
				suiteUpdate();
			}
		})
		});
		loadingArea.hide();
		controlArea.show();	
	}

	function startSetTest(){
		iTest = 0;
		updateTestXML();
		controlArea.hide();
		caseListArea.hide();
		testArea.show();
		$("#testframe").show();	
		$("#statusframe").show();	
		statusFrame.contentWindow.document.body.innerHTML = "";
		statusNode = init_status_frame();
		doTest();
		iSuite = '';
	}

	function initSelectionPage(){
		$("#statusframe").show();
		statusFrame.height = "10%";
		$("#testframe").show();
		testFrame.height = "70%";
		testFrame.src='';
		manageArea.hide();
		testArea.hide();
		controlArea.show();
	}
	//Selection page end

	function preCheck() {
		testArea = $("#testarea");
                caseListArea = $("#caselistarea");
                manageArea = $("#managearea");
                controlArea = $("#controlarea");
		loadingArea = $("#loadingarea");
                testArea.hide();
                caseListArea.hide();
                manageArea.hide();
                controlArea.hide();
		loadingArea.show();
		server_url = "http://127.0.0.1:8000/check_server";
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			success : init_test,
			error : function(x, t, e) {
				print_error_log("can't find a http server",
						"run widget in the standalone mode");
				need_ajax = false;
				init_standalone();
			}
		});
	}

	function init_standalone() {
		getParms();
		resizeFontSize();

		testFrame = document.getElementById('testframe');
		statusFrame = document.getElementById('statusframe');
		messageFrame = document.getElementById('messageframe');
		$("#messageframe").hide();

		if (!xmldoc) {
			$.ajax({
				async : false,
				type : "GET",
				url : ttestsuite,
				dataType : "xml",
				success : runTestSuite,
				error : function(x, t, e){runTestSuiteSer();}
			});
		}
	}

	function escape_html(s) {
		return s.replace(/\&/g, "&amp;").replace(/</g, "&lt;").replace(/"/g,
				"&quot;").replace(/'/g, "&#39;");
	}

	function check_timeout(time) {
		if (time == 11) {
			report('BLOCK', "Time is out");
		}
		sleep_time = time * 50;
		setTimeout("CheckResult('yes', " + time + ")", sleep_time);
	}

	function CheckResult(need_check_block, sleep_time) {
		var message = "";
		var total_num = "";
		var locator_key = "";
		var value = "";

		var oTestWin = testFrame.contentWindow;
		var oTestDoc = oTestWin.document;
		var case_uri = current_page_uri;

		try {
			if (oTestWin.document.readyState == "complete") {
				total_num = getTestPageParam(case_uri, "total_num");
				locator_key = getTestPageParam(case_uri, "locator_key");
				value = getTestPageParam(case_uri, "value");
				oPass = $(oTestDoc).find(".pass");
				oFail = $(oTestDoc).find(".fail");

				// Test page has parameters
				if (total_num != "" && locator_key != "" && value != "") {
					if (locator_key == "id") {
						var results;
						var passes;
						var fails;

						var oRes = $(oTestDoc).find("table#results");
						if (oRes) {
							results = $(oRes).find('tr');
							passes = $(oRes).find('tr.pass');
							fails = $(oRes).find('tr.fail');
						}

						if (passes.length + fails.length == total_num) {
							var i = 1;
							for (i = 1; i <= total_num; i++) {
								if (i.toString() != value) {
									continue;
								}
								var rest = results[i].childNodes[0].innerText;
								var desc = results[i].childNodes[1].innerText;
								var msg = results[i].childNodes[2].innerText;
								if (rest && rest.toUpperCase() == "PASS")
									report('PASS', msg);
								else
									report('FAIL', msg);
								break;
							}
						} else {
							var i;
							for (i = 0; i < fails.length; i++) {
								var desccell = fails[i].childNodes[1];
								if (desccell)
									message += "###Test Start###"
											+ desccell.innerText
											+ "###Test End###";
								var msgcell = fails[i].childNodes[2];
								if (msgcell)
									message += "###Error1 Start###"
											+ msgcell.innerText
											+ "###Error1 End###";
							}
							report('FAIL', message);
						}
					} else if (locator_key == "test_name") {
						// Place holder
					} else if (locator_key == "msg") {
						// Place holder
					} else {
						alert("Unknown locator key");
					}
				} else if (oPass.length > 0 && oFail.length == 0) {
					if (oTestWin.resultdiv)
						message = oTestWin.resultdiv.innerHTML;
					report('PASS', message);
				} else if (oFail.length > 0) {
					var oRes = $($(oTestDoc).find("table#results")).get(0);
					// Get error log
					if (oRes) {
						var fails = $(oRes).find('tr.fail');
						var i;
						for (i = 0; i < fails.length; i++) {
							var desccell = fails[i].childNodes[1];
							if (desccell)
								message += "###Test Start###"
										+ desccell.innerText + "###Test End###";
							var msgcell = fails[i].childNodes[2];
							if (msgcell)
								message += "###Error2 Start###"
										+ msgcell.innerText
										+ "###Error2 End###";
						}
					}
					report('FAIL', message);
				} else // oFail.length==0 && oPass.length==0
				if (need_check_block == 'yes') {
					next_sleep_time = sleep_time + 1;
					check_timeout(next_sleep_time);
					return;
				}
			} else // not complete
			if (need_check_block == 'yes') {
				next_sleep_time = sleep_time + 1;
				check_timeout(next_sleep_time);
				return;
			}
		} catch (e) {
			report('BLOCK', e);
		}
	}

	function report(result, log) {

		if (iTest >= Tests.length)
			return;
		$(Tests[iTest]).attr('result', result);
		var doc = $.parseXML("<result_info>" + "<actual_result>" + result
				+ "</actual_result>" + "<start>" + startTime + "</start>"
				+ "<end>" + new Date() + "</end>" + "<stdout>"
				+ escape_html(log) + "</stdout>" + "</result_info>");
		$(Tests[iTest]).append(doc.documentElement);

		statusNode.innerHTML = "Test #" + (iTest + 1) + "/" + Tests.length
				+ "(" + result + ") " + current_page_uri;

		try {
			var starts = log.indexOf('value:');
			var stops = log.lastIndexOf(',');
			var resultinfo = log.substring(starts + 6, stops);
			$(Tests[iTest]).find("measurement").attr('value', resultinfo);
		} catch (e) {
		}

		iTest++;

		if (activetest) {
			doTest();
		} else {
			activetest = true;
		}
	}

	function doTest() {
		while (iTest < Tests.length) {
			if ($(Tests[iTest]).attr('execution_type') != 'auto') {
				iTest++;
				continue;
			}
			var ts = $(Tests[iTest]).find('test_script_entry');
			if (ts.length == 0) {
				iTest++;
				continue;
			}
			var it = $(ts).get(0);
			var tstr = $(it).attr('timeout');
			if (!tstr)
				timeout = 8 * defTime;
			else {
				var t;
				try {
					t = parseInt(tstr) * 1000;
				} catch (e) {
					t = 8 * defTime;
				}
				timeout = t;
			}

			pset = $(Tests[iTest]).parent().attr('name');
			psuite = $(Tests[iTest]).parent().parent().attr('name');

			startTime = new Date();

			current_page_uri = $(it).text();
			var index = current_page_uri.indexOf("?");
			var test_page = "";
			if (need_ajax) {
				var svr = server + "/test_hint";
				$.ajax({
					async : false,
					type : "POST",
					url : svr,
					data : {
						suite : psuite,
						set : pset,
						testcase : current_page_uri
					},
					error : function(x, t, e) {
						print_error_log("doTest", e);
					}
				});
			}
			if (index >= 0)
				test_page = current_page_uri.substring(0, index);
			else
				test_page = current_page_uri;

			// Don't load the same test page again
			if (test_page == last_test_page) {
				print_error_log("test page url is the same as the last one",
						test_page);
				activetest = false;
				CheckResult('yes', 0);
				continue;
			}

			if ((current_page_uri.indexOf("2DTransforms") != -1)
					|| (current_page_uri.indexOf("3DTransforms") != -1)) {
				testFrame.height = 500000 + "px";
			} else {
				testFrame.height = 2500 + "px";
			}
			testFrame.src = current_page_uri;
			last_test_page = test_page;
			if (testFrame.attachEvent) {
				testFrame.attachEvent("onload", function() {
					CheckResult('yes', 0);
				});
			} else {
				testFrame.onload = function() {
					CheckResult('yes', 0);
				};
			}
			return;
		}
		doManualTest();
	}

	function doManualTest() {
		manualcaseslist = new Array();
		var iTemp1 = 0, iTemp2 = 0;
		while (iTemp1 < Tests.length) {
			if ($(Tests[iTemp1]).attr('execution_type') == 'manual') {
				manualcaseslist[iTemp2] = new manualcases();
				manualcaseslist[iTemp2].casesid = $(Tests[iTemp1]).attr('id');
				manualcaseslist[iTemp2].index = iTemp1;
				manualcaseslist[iTemp2].result = $(Tests[iTemp1])
						.attr('result');
				iTemp2++;
			}
			iTemp1++;
		}
		if (iTemp2 > 0) {
			statusFrame.src = "manualharness.html";
		} else if (iTest == Tests.length) {
			setTimeout("PublishResult()", 2000);
		}
		testFrame.src = '';
	}

	function PublishResult() {
		$("#statusframe").hide();
		var resultXML;
		resultXML = "<title>HTML5 Test Result XML</title>";
		resultXML += "<head><style type='text/css'>\
	html {font-family:DejaVu Sans, Bitstream Vera Sans, Arial, Sans;}\
	section#summary {margin-bottom:1em;}\
	table#results {\
	    border-collapse:collapse;\
	    table-layout:fixed;\
	    width:100%;\
	}\
	table#results th:first-child,\
	table#results td:first-child {\
	    width:30%;\
	}\
	table#results th:last-child,\
	table#results td:last-child {\
	    width:30%;\
	}\
	table#results th {\
	    padding:0;\
	    padding-bottom:0.5em;\
	    text-align:left;\
	    border-bottom:medium solid black;\
	}\
	table#results td {\
	    padding:1em;\
	    padding-bottom:0.5em;\
	    border-bottom:thin solid black;\
	}\
	</style><head>";

		resultXML += "<section id='summary'>";
		resultXML += "<h2>Summary</h2>";
		var ipass = $(xmldoc).find("testcase[result='PASS']").length;
		var failList = $(xmldoc).find("testcase[result='FAIL']");
		var ifail = failList.length;
		resultXML += "<h3>Total:" + Tests.length
				+ " Pass:<span style='color:green;'>" + ipass
				+ "</span> Fail:<span style='color:red;'>" + ifail
				+ "</span></h3>";
		resultXML += "</section>";
		resultXML += "<p><table id='results'> <tr> <th> TestSet </th> <th> Pass </th> <th> Fail </th></tr>";
		var Sets = $(xmldoc).find("set");
		var i = 0;
		for (i = 0; i < Sets.length; i++) {
			ipass = $(Sets[i]).find("testcase[result='PASS']").length;
			ifail = $(Sets[i]).find("testcase[result='FAIL']").length;
			resultXML += "<tr>";
			resultXML += "<td>" + $(Sets[i]).attr('name') + "</td>";
			resultXML += "<td style='color:green;'>" + ipass
					+ "</td><td style='color:red;'>" + ifail + "</td>";
			resultXML += "</tr>";
		}
		resultXML += "</table>";
		if (ifail > 0) {
			resultXML += "<section id='failedlist'>";
			resultXML += "<h2>Fails</h2>";
			resultXML += "<ul>";
			for (i = 0; i < failList.length; i++) {
				var ts = $(failList[i]).find("test_script_entry");
				if (ts.length > 0) {
					var t = ts.get(0);
					resultXML += "<li style='color:red;'>" + $(t).text()
							+ "</li>";
				}
			}
			resultXML += "</ul>";
			resultXML += "</section>";
		}
		resultXML += "<h2>Test Result XML</h2>";
		resultXML += "<textarea id='results' style='width: 100%; height: 70%;' name='filecontent' disabled='disabled'>"
				+ (new XMLSerializer()).serializeToString(xmldoc) + "</textarea>";
                manageArea.show();
                testFrame.height = "95%";
	        try {
                        testFrame.contentWindow.document.open();
                        testFrame.contentWindow.document.writeln(resultXML);
                        testFrame.contentWindow.document.close();
                } catch (e) {
                        testFrame.onload=function(){
					testFrame.contentWindow.document.open();
					testFrame.contentWindow.document.writeln(resultXML);
					testFrame.contentWindow.document.close();testFrame.onload='';
			};
                        testFrame.src = "";
                }
	}

	// merge code from application.js
	function init_test() {
		loadingArea.hide();
		testArea.show();
		var session_id = Math.round(Math.random() * 10000);
		init_message_frame();
		save_session_id(session_id);
		sync_session_id(session_id);
		start_test();
	}

	function init_message_frame() {
		messageFrame = document.getElementById('messageframe');
		messageWin = messageFrame.contentWindow;
		messageNode = messageWin.document.getElementById('message_div');
		if (null == messageNode) {
			messageNode = messageWin.document.createElement("div");
			messageNode.id = "message_div";
			messageWin.document.body.appendChild(messageNode);
			messageNode.innerHTML = "Message Area";
		}
		return messageNode;
	}

	function print_error_log(command, message) {
		messageFrame = document.getElementById('messageframe');
		messageFrame.height = 160 + "px";
		messageNode = init_message_frame();
		messageNode.innerHTML = "Message Area<div id=\"log_title\"></div><br/>Command: <div id=\"log_command\">"
				+ command
				+ "</div><br/>Message: <div id=\"log_message\">"
				+ message + "</div>";
	}
		function save_session_id(session_id) {
		statusFrame = document.getElementById('statusframe');
		statusFrame.height = 270 + "px";
		statusWin = statusFrame.contentWindow;
		sessionIdNode = statusWin.document.getElementById('session_id_div');
		if (null == sessionIdNode) {
			sessionIdNode = statusWin.document.createElement("div");
			sessionIdNode.id = "session_id_div";
			statusWin.document.body.appendChild(sessionIdNode);
			sessionIdNode.innerHTML = "Session ID: <div id=\"session_id\">"
					+ session_id
					+ "</div><br/><div id=\"execution_progress\"></div><br/>";
		}
	}
		function sync_session_id(session_id) {
		var server_url = server + "/init_session_id";
		server_url += "?session_id=" + session_id;
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			error : function(x, t, e) {
				print_error_log("sync_session_id", e);
			}
		});
	}

	function get_session_id() {
		statusFrame = document.getElementById('statusframe');
		statusWin = statusFrame.contentWindow;
		sessionIdNode = statusWin.document.getElementById('session_id');
		return sessionIdNode.innerHTML;
	}

	function start_test() {
		try {
			var task = ask_test_task();
		} catch (e) {
			print_error_log("start_test_ask_test_task", e);
		}
		try {
			if (task == 1) {
				print_error_log("start_test_execute_test_task",
						"Invalid session");
			} else if (task == -1) {
				print_error_log("restart client process activated",
						"this window will be closed in 2sec");
				setTimeout("window.open('','_self','');window.close()", 2000);
			} else if (task == null) {
				print_error_log(
						"get auto case failed, client will be restarted later",
						"this window will be closed in 2sec");
				setTimeout("window.open('','_self','');window.close()", 2000);
			} else if (task != 0) {
				var progress = check_execution_progress();
				execute_test_task(task, progress);
			} else {
				execute_manual_test();
			}
		} catch (e) {
			print_error_log("start_test_execute_test_task", e);
		}
	}

	function ask_generate_xml() {
		var server_url = server + "/generate_xml";
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			error : function(x, t, e) {
				print_error_log("ask_generate_xml", e);
			}
		});
		setTimeout("window.open('','_self','');window.close()", winCloseTimeout);
	}

	function extract_all_manual() {
		var server_url = server + "/manual_cases";
		var tasks = null;
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			dataType : "text",
			success : function(txt) {
				task = $.parseJSON(txt);
				if (0 == task.none) {
					task = null;
				}
			},
			error : function(x, t, e) {
				print_error_log("extract_all_manual", e);
			}
		});
		return task;
	}

	function ask_test_task() {
		var server_url = server + "/auto_test_task";
		var task = null;
		session_id = get_session_id();
		server_url += "?session_id=" + session_id;
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			dataType : "text",
			success : function(txt) {
				task = $.parseJSON(txt);
				if (task.none == 0) {
					task = 0;
				}
				if (task.invalid == 0) {
					task = 1;
				}
				if (task.stop == 0) {
					task = -1;
				}
			},
			error : function(x, t, e) {
				print_error_log("ask_test_task", e);
			}
		});
		return task;
	}

	function check_execution_progress() {
		var server_url = server + "/check_execution_progress";
		var progress = null;
		session_id = get_session_id();
		server_url += "?session_id=" + session_id;
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			dataType : "text",
			success : function(txt) {
				progress = $.parseJSON(txt);
			},
			error : function(x, t, e) {
				print_error_log("check_execution_progress", e);
			}
		});
		return progress;
	}

	function ask_next_step() {
		var server_url = server + "/ask_next_step";
		var next_step = null;
		session_id = get_session_id();
		server_url += "?session_id=" + session_id;
		$.ajax({
			async : false,
			url : server_url,
			type : "GET",
			dataType : "text",
			success : function(txt) {
				next_step = $.parseJSON(txt);
			},
			error : function(x, t, e) {
				print_error_log("ask_next_step", e);
			}
		});
		return next_step;
	}

	function init_status_frame() {
		statusFrame = document.getElementById('statusframe');
		statusWin = statusFrame.contentWindow;
		statusNode = statusWin.document.getElementById('status_div');
		if (null == statusNode) {
			statusNode = statusWin.document.createElement("div");
			statusNode.id = "status_div";
			statusWin.document.body.appendChild(statusNode);
		}
		return statusNode;
	}

	function execute_test_task(json_task, json_progress) {
		try {
			testFrame = document.getElementById('testframe');
			statusNode = init_status_frame();
			// update execution progress
			statusFrame = document.getElementById('statusframe');
			statusWin = statusFrame.contentWindow;
			progressNode = statusWin.document
					.getElementById('execution_progress');
			progressNode.innerHTML = "Total:" + json_progress.total
					+ ", Current:" + json_progress.current;
			// update case info
			statusNode.innerHTML = "Test Purpose:<div id=\"test_purpose_div\">"
					+ json_task.purpose
					+ "</div><br/>Test Entry:<div id=\"test_entry_div\">"
					+ json_task.entry
					+ "</div><br/>Last Test Result:<div id=\"test_result_div\">"
					+ json_progress.last_test_result + "</div>";
			current_page_uri = json_task.entry;
			var index = current_page_uri.indexOf("?");
			var test_page = "";
			if (index >= 0)
				test_page = current_page_uri.substring(0, index);
			else
				test_page = current_page_uri;
			// Don't load the same test page again
			if (test_page == last_test_page) {
				print_error_log("test page url is the same as the last one",
						test_page);
				extract_case_result('yes', 0);
				return;
			}
			if ((current_page_uri.indexOf("2DTransforms") != -1)
					|| (current_page_uri.indexOf("3DTransforms") != -1)) {
				testFrame.height = 500000 + "px";
			} else {
				testFrame.height = 2500 + "px";
			}
			testFrame.src = current_page_uri;
			last_test_page = test_page;
			if (testFrame.attachEvent) {
				testFrame.attachEvent("onload", function() {
					extract_case_result('yes', 0);
				});
			} else {
				testFrame.onload = function() {
					extract_case_result('yes', 0);
				};
			}
		} catch (e) {
			print_error_log("execute_test_task", e);
		}
	}

	function check_block_result_again(time) {
		if (time == 10) {
			setTimeout("extract_case_result('no', 10)", 500);
			return;
		}
		sleep_time = time * 50;
		setTimeout("extract_case_result('yes', " + time + ")", sleep_time);
	}

	function extract_case_result(need_check_block, sleep_time) {
		testFrame = document.getElementById('testframe');
		var oTestWin = testFrame.contentWindow;
		var oTestDoc = testFrame.contentWindow.document;
		var result = "BLOCK";
		var case_msg = "";
		oPass = $(oTestDoc).find(".pass");
		oFail = $(oTestDoc).find(".fail");
		case_uri = testFrame.src.toString();

		total_num = getTestPageParam(case_uri, "total_num");
		locator_key = getTestPageParam(case_uri, "locator_key");
		value = getTestPageParam(case_uri, "value");
		if (total_num != "" && locator_key != "" && value != "") {
			if (locator_key == "id") {
				var results;
				var passes;
				var fails;

				var oRes = $(oTestDoc).find("table#results");
				if (oRes) {
					results = $(oRes).find('tr');
					passes = $(oRes).find('tr.pass');
					fails = $(oRes).find('tr.fail');
				}
				if (passes.length + fails.length == total_num) {
					var i = 1;
					for (i = 1; i <= total_num; i++) {
						if (i.toString() != value) {
							continue;
						}
						var rest = results[i].childNodes[0].innerText;
						var desc = results[i].childNodes[1].innerText;
						case_msg = results[i].childNodes[2].innerText;

						if (rest && rest.toUpperCase() == "PASS") {
							result = "PASS";
						} else {
							result = "FAIL";
						}
						break;
					}
				} else {
					var i;
					for (i = 0; i < fails.length; i++) {
						var desccell = fails[i].childNodes[1];
						if (desccell) {
							case_msg += "###Test Start###" + desccell.innerText
									+ "###Test End###";
						}
						var msgcell = fails[i].childNodes[2];
						if (msgcell) {
							case_msg += "###Error1 Start###"
									+ msgcell.innerText + "###Error1 End###";
						}
					}
					result = "FAIL";
				}
			}
		} else if (oPass.length > 0 && oFail.length == 0) {
			if (oTestWin.resultdiv) {
				case_msg = oTestWin.resultdiv.innerHTML;
			}
				result = "PASS";
		} else if (oFail.length > 0) {
			var oRes = $($(oTestDoc).find("table#results")).get(0);
			// Get error log
			if (oRes) {
				var fails = $(oRes).find('tr.fail');
				var i;
				for (i = 0; i < fails.length; i++) {
					var desccell = fails[i].childNodes[1];
					if (desccell) {
						case_msg += "###Test Start###" + desccell.innerText
								+ "###Test End###";
					}
					var msgcell = fails[i].childNodes[2];
					if (msgcell) {
						case_msg += "###Error2 Start###" + msgcell.innerText
								+ "###Error2 End###";
					}
				}
			}
			result = "FAIL";
		} else {
			if (need_check_block == 'yes') {
				next_sleep_time = sleep_time + 1;
				check_block_result_again(next_sleep_time);
				return;
			}
		}
		var next_step = ask_next_step();
		commit_test_result(result, case_msg);
		if (next_step.step == "continue") {
			start_test();
		} else {
			print_error_log("memory collection process activated",
					"this window will be closed in 2sec");
			setTimeout("window.open('','_self','');window.close()", 2000);
		}
	}

	var manual_test_step = function() {
		this.order = 0;
		this.desc = "";
		this.expected = "";
	};

	var manual_cases = function() {
		this.casesid = "";
		this.index = 0;
		this.result = "";
		this.entry = "";
		this.pre_con = "";
		this.post_con = "";
		this.purpose = "";
		this.steps = new Array();
	};

	function execute_manual_test() {
		manualcaseslist = new Array();
		tasks = extract_all_manual();
		for ( var i = 0; i < tasks.length; i++) {
			parent.document.getElementById("statusframe").height = 385 + "px";
			manualcaseslist[i] = new manual_cases();
			manualcaseslist[i].casesid = tasks[i].case_id;
			manualcaseslist[i].index = i;
			manualcaseslist[i].entry = tasks[i].entry;
			manualcaseslist[i].pre_con = tasks[i].pre_condition;
			manualcaseslist[i].post_con = tasks[i].post_condition;
			manualcaseslist[i].purpose = tasks[i].purpose;

			if (tasks[i].steps != undefined) {
				for ( var j = 0; j < tasks[i].steps.length; j++) {
					this_manual_step = new manual_test_step();
					this_manual_step.order = parseInt(tasks[i].steps[j].order);
					this_manual_step.desc = tasks[i].steps[j].step_desc;
					this_manual_step.expected = tasks[i].steps[j].expected;
					manualcaseslist[i].steps[this_manual_step.order - 1] = this_manual_step;
				}
			}
		}

		if (tasks.length > 0) {
			statusFrame.src = "manual_harness.html";
			$($($('#main')).get(0)).attr('rows', "100,*");
		} else {
			// No manual cases, generate the result.
			ask_generate_xml();
		}
		testFrame = document.getElementById('testframe');
		testFrame.src = '';
	}

	function commit_test_result(result, msg) {
		statusFrame = document.getElementById('statusframe');
		purposeNode = statusWin.document.getElementById('test_purpose_div');
		session_id = get_session_id();
		var purpose_str = purposeNode.innerHTML
		var server_url = server + "/commit_result";
		$.ajax({
			async : false,
			url : server_url,
			type : "POST",
			data : {
				"purpose" : purpose_str,
				"result" : result,
				"msg" : "[Message]" + msg,
				"session_id" : session_id
			},
			dataType : "json",
			beforeSend : function(x) {
				if (x && x.overrideMimeType) {
					x.overrideMimeType("application/j-son;charset=UTF-8");
				}
			},
			error : function(x, t, e) {
				print_error_log("commit_test_result", e);
			}
		});
	}
</script>
</head>
<body onload="preCheck()">
<div id="loadingarea" style="text-align:left">Loading ......</div>
<div id="managearea" style="text-align:right">
	<input type="button" id="backbutton" class="button" onclick="initSelectionPage()" value="Return Home"></input>
	<input type="button" id="closewindowbutton" class="button" onclick="window.open('','_self','');window.close()" value="Close Window"></input>
</div>
<div id="controlarea">
        <table class="layouttable"><tr id="versionrow"><td>
                <label class="label">Tests Version: </label>
        </td><td>
		<label class="label" id="versiontext"></label>
        </td></tr><tr><td>
		<label class="label">Test Suites: </label>
	</td><td>
		<input type="button" class="button" onclick="suiteUpdateButtonUp()" value="<"></input>
		<select class="selectbox" id="suitelist" onchange="suiteUpdate()"></select>
		<input type="button" class="button" onclick="suiteUpdateButtonDown()" value=">"></input>
        </td></tr><tr><td>
                <label class="label">Test Sets: </label>
        </td><td>
		<input type="button" class="button" onclick="setUpdateButtonUp()" value="<"></input>
                <select class="selectbox" id="setlist" onchange="setUpdate()"></select>
		<input type="button" class="button" onclick="setUpdateButtonDown()" value=">"></input>
        </td></tr><tr><td>
                <label class="label">Execution Type: </label>
        </td><td>
		<input type="button" class="button" onclick="exeTypeUpdateButtonUp()" value="<"></input>
                <select class="selectbox" id="exetypelist" onchange="exeTypeUpdate()"></select>
		<input type="button" class="button" onclick="exeTypeUpdateButtonDown()" value=">"></input>
        </td></tr><tr><td colspan="2">
                <input type="button" id="runbutton" class="button" value="Run" onclick="startSetTest()"/>
		<label class="label">Or</label>
                <input type="button" id="runbutton" class="button" value="View Test Cases" onclick="showCases()"/>
		<label class="label"><input type="checkbox" id="iframebox" class="checkbox" checked>Run Cases In Iframe</label>
        </td></tr></table>
</div>
<div id="caselistarea">
	<div id="pageswitch01"></div>
	<div id="caselists"></div>
	<div id="pageswitch02"></div>
</div>
<div id="testarea">
	<iframe id="messageframe" height="15%" frameborder="0" marginwidth="0" marginheight="0"></iframe>
	<iframe id="statusframe" height="10%" frameborder="0" marginwidth="0" marginheight="0"></iframe>
	<iframe id="testframe" height="70%" frameborder="0" marginwidth="0" marginheight="0"></iframe>
<div>
</body>
</html>
